{
  "type": "excalidraw",
  "version": 2,
  "source": "claude-code-mrhealth",
  "elements": [
    {"id":"logo","type":"image","x":40,"y":15,"width":40,"height":40,"status":"saved","fileId":"cloud_functions_logo","scale":[1,1]},
    {"id":"title","type":"text","x":90,"y":20,"width":1000,"height":40,"text":"Cloud Functions - Detailed Architecture","fontSize":28,"fontFamily":3,"strokeColor":"#4285F4"},
    {"id":"subtitle","type":"text","x":40,"y":65,"width":1000,"height":20,"text":"2nd Generation | Python 3.11 | Event-Driven Processing | Zero Infrastructure Management","fontSize":14,"fontFamily":3,"strokeColor":"#868e96"},

    {"id":"cf1_zone","type":"rectangle","x":40,"y":120,"width":500,"height":450,"strokeColor":"#d9480f","backgroundColor":"#fff4e6","fillStyle":"solid","strokeWidth":3,"roundness":{"type":3}},
    {"id":"cf1_title","type":"text","x":60,"y":135,"width":460,"height":28,"text":"csv-processor","fontSize":20,"fontFamily":3,"strokeColor":"#d9480f"},
    {"id":"cf1_desc","type":"text","x":60,"y":168,"width":460,"height":15,"text":"Event-driven CSV validation and BigQuery loading","fontSize":11,"fontFamily":3,"strokeColor":"#868e96"},

    {"id":"cf1_trigger","type":"rectangle","x":60,"y":195,"width":220,"height":90,"strokeColor":"#1971c2","backgroundColor":"#e7f5ff","fillStyle":"solid","strokeWidth":1},
    {"id":"cf1_trigger_title","type":"text","x":75,"y":205,"width":190,"height":18,"text":"Trigger","fontSize":12,"fontFamily":3,"strokeColor":"#1971c2"},
    {"id":"cf1_trigger_content","type":"text","x":75,"y":228,"width":190,"height":50,"text":"Type: Eventarc\nEvent: storage.object.finalized\nBucket: dados-sales-*\nPrefix: raw/csv_sales/","fontSize":9,"fontFamily":3,"strokeColor":"#495057"},

    {"id":"cf1_config","type":"rectangle","x":300,"y":195,"width":220,"height":90,"strokeColor":"#087f5b","backgroundColor":"#e6fcf5","fillStyle":"solid","strokeWidth":1},
    {"id":"cf1_config_title","type":"text","x":315,"y":205,"width":190,"height":18,"text":"Configuration","fontSize":12,"fontFamily":3,"strokeColor":"#087f5b"},
    {"id":"cf1_config_content","type":"text","x":315,"y":228,"width":190,"height":50,"text":"Memory: 512MB\nTimeout: 60 seconds\nMax Instances: 10\nMin Instances: 0 (scale to zero)","fontSize":9,"fontFamily":3,"strokeColor":"#495057"},

    {"id":"cf1_flow","type":"rectangle","x":60,"y":300,"width":460,"height":180,"strokeColor":"#495057","backgroundColor":"#fff","fillStyle":"solid","strokeWidth":1},
    {"id":"cf1_flow_title","type":"text","x":75,"y":310,"width":430,"height":18,"text":"Processing Flow","fontSize":12,"fontFamily":3,"strokeColor":"#495057"},
    {"id":"cf1_flow_content","type":"text","x":75,"y":333,"width":430,"height":140,"text":"1. Receive CloudEvent from Eventarc\n   - Extract: bucket, object_name, content_type\n\n2. Validate file type and naming convention\n   - Pattern: (pedidos|itens_pedido)_YYYYMMDD.csv\n\n3. Download CSV from GCS\n   - Stream to pandas DataFrame\n\n4. Validate schema with PyArrow\n   - Enforce column types, check required fields\n\n5. Load to BigQuery Bronze\n   - Mode: WRITE_APPEND | Partition: _ingest_date\n\n6. Log success metrics to Cloud Logging","fontSize":9,"fontFamily":3,"strokeColor":"#495057"},

    {"id":"cf1_deps","type":"rectangle","x":60,"y":495,"width":460,"height":60,"strokeColor":"#7048e8","backgroundColor":"#f3f0ff","fillStyle":"solid","strokeWidth":1},
    {"id":"cf1_deps_title","type":"text","x":75,"y":505,"width":200,"height":18,"text":"Dependencies","fontSize":11,"fontFamily":3,"strokeColor":"#7048e8"},
    {"id":"cf1_deps_content","type":"text","x":75,"y":525,"width":430,"height":25,"text":"google-cloud-bigquery, google-cloud-storage, pandas, pyarrow, functions-framework","fontSize":9,"fontFamily":3,"strokeColor":"#495057"},

    {"id":"cf2_zone","type":"rectangle","x":570,"y":120,"width":500,"height":450,"strokeColor":"#9c36b5","backgroundColor":"#f8f0fc","fillStyle":"solid","strokeWidth":3,"roundness":{"type":3}},
    {"id":"cf2_title","type":"text","x":590,"y":135,"width":460,"height":28,"text":"pg-reference-extractor","fontSize":20,"fontFamily":3,"strokeColor":"#9c36b5"},
    {"id":"cf2_desc","type":"text","x":590,"y":168,"width":460,"height":15,"text":"Extract reference data from PostgreSQL via SSH tunnel","fontSize":11,"fontFamily":3,"strokeColor":"#868e96"},

    {"id":"cf2_trigger","type":"rectangle","x":590,"y":195,"width":220,"height":90,"strokeColor":"#1971c2","backgroundColor":"#e7f5ff","fillStyle":"solid","strokeWidth":1},
    {"id":"cf2_trigger_title","type":"text","x":605,"y":205,"width":190,"height":18,"text":"Trigger","fontSize":12,"fontFamily":3,"strokeColor":"#1971c2"},
    {"id":"cf2_trigger_content","type":"text","x":605,"y":228,"width":190,"height":50,"text":"Type: HTTP (Cloud Scheduler)\nSchedule: 0 4 * * * (01:00 BRT)\nMethod: POST\nAuth: Service Account","fontSize":9,"fontFamily":3,"strokeColor":"#495057"},

    {"id":"cf2_config","type":"rectangle","x":830,"y":195,"width":220,"height":90,"strokeColor":"#087f5b","backgroundColor":"#e6fcf5","fillStyle":"solid","strokeWidth":1},
    {"id":"cf2_config_title","type":"text","x":845,"y":205,"width":190,"height":18,"text":"Configuration","fontSize":12,"fontFamily":3,"strokeColor":"#087f5b"},
    {"id":"cf2_config_content","type":"text","x":845,"y":228,"width":190,"height":50,"text":"Memory: 256MB\nTimeout: 300 seconds\nMax Instances: 1\nRetry: 3x with backoff","fontSize":9,"fontFamily":3,"strokeColor":"#495057"},

    {"id":"cf2_flow","type":"rectangle","x":590,"y":300,"width":460,"height":180,"strokeColor":"#495057","backgroundColor":"#fff","fillStyle":"solid","strokeWidth":1},
    {"id":"cf2_flow_title","type":"text","x":605,"y":310,"width":430,"height":18,"text":"Processing Flow","fontSize":12,"fontFamily":3,"strokeColor":"#495057"},
    {"id":"cf2_flow_content","type":"text","x":605,"y":333,"width":430,"height":140,"text":"1. Retrieve secrets from Secret Manager\n   - pg-host, pg-ssh-user, pg-ssh-private-key, pg-db-*\n\n2. Establish SSH tunnel to K3s node\n   - Paramiko: Ed25519 key authentication\n   - Port forward: local:5432 -> node:30432 -> pg:5432\n\n3. Connect to PostgreSQL database\n   - psycopg2: mrhealth_readonly user (SELECT only)\n\n4. Extract reference tables\n   - SELECT * FROM pais, estado, unidade, produto\n\n5. Upload CSVs to GCS\n   - Path: raw/reference_data/{table}.csv\n\n6. Trigger csv-processor (optional) or wait for Bronze load","fontSize":9,"fontFamily":3,"strokeColor":"#495057"},

    {"id":"cf2_deps","type":"rectangle","x":590,"y":495,"width":460,"height":60,"strokeColor":"#7048e8","backgroundColor":"#f3f0ff","fillStyle":"solid","strokeWidth":1},
    {"id":"cf2_deps_title","type":"text","x":605,"y":505,"width":200,"height":18,"text":"Dependencies","fontSize":11,"fontFamily":3,"strokeColor":"#7048e8"},
    {"id":"cf2_deps_content","type":"text","x":605,"y":525,"width":430,"height":25,"text":"paramiko, psycopg2-binary, google-cloud-storage, google-cloud-secret-manager, functions-framework","fontSize":9,"fontFamily":3,"strokeColor":"#495057"},

    {"id":"secrets_box","type":"rectangle","x":40,"y":590,"width":500,"height":130,"strokeColor":"#c92a2a","backgroundColor":"#fff5f5","fillStyle":"solid","strokeWidth":2},
    {"id":"secrets_title","type":"text","x":60,"y":605,"width":200,"height":22,"text":"Secret Manager Integration","fontSize":14,"fontFamily":3,"strokeColor":"#c92a2a"},
    {"id":"secrets_content","type":"text","x":60,"y":635,"width":460,"height":75,"text":"Secrets Used by pg-reference-extractor:\n  - projects/PROJECT_ID/secrets/pg-host/versions/latest\n  - projects/PROJECT_ID/secrets/pg-ssh-user/versions/latest\n  - projects/PROJECT_ID/secrets/pg-ssh-private-key/versions/latest  (Ed25519 private key)\n  - projects/PROJECT_ID/secrets/pg-db-name/versions/latest\n  - projects/PROJECT_ID/secrets/pg-db-user/versions/latest\n  - projects/PROJECT_ID/secrets/pg-db-password/versions/latest","fontSize":9,"fontFamily":3,"strokeColor":"#495057"},

    {"id":"error_box","type":"rectangle","x":570,"y":590,"width":500,"height":130,"strokeColor":"#e03131","backgroundColor":"#fff5f5","fillStyle":"solid","strokeWidth":2},
    {"id":"error_title","type":"text","x":590,"y":605,"width":200,"height":22,"text":"Error Handling","fontSize":14,"fontFamily":3,"strokeColor":"#e03131"},
    {"id":"error_content","type":"text","x":590,"y":635,"width":460,"height":75,"text":"csv-processor:\n  - Invalid schema -> Move file to quarantine/, log error\n  - BigQuery load failure -> Retry with exponential backoff\n  - Timeout -> File remains in raw/, will be retried\n\npg-reference-extractor:\n  - SSH connection failure -> Retry 3x with 30s delay\n  - PostgreSQL timeout -> Log warning, continue with next table\n  - Partial extraction -> Upload successful tables only","fontSize":9,"fontFamily":3,"strokeColor":"#495057"},

    {"id":"monitoring_box","type":"rectangle","x":40,"y":740,"width":1030,"height":80,"strokeColor":"#2f9e44","backgroundColor":"#ebfbee","fillStyle":"solid","strokeWidth":2},
    {"id":"monitoring_title","type":"text","x":60,"y":755,"width":200,"height":22,"text":"Monitoring & Observability","fontSize":14,"fontFamily":3,"strokeColor":"#2f9e44"},
    {"id":"monitoring_content","type":"text","x":60,"y":785,"width":990,"height":30,"text":"Cloud Logging: Structured JSON logs (severity, function_name, file_processed, rows_loaded, execution_time_ms)\nCloud Monitoring: Execution count, error rate, latency percentiles, memory usage\nAlerting: Error rate > 5% for 5 minutes -> PagerDuty/Slack notification","fontSize":9,"fontFamily":3,"strokeColor":"#495057"}
  ],
  "appState": {"viewBackgroundColor":"#ffffff","gridSize":null},
  "files": {
    "cloud_functions_logo": {
      "mimeType": "image/svg+xml",
      "id": "cloud_functions_logo",
      "dataURL": "data:image/svg+xml;base64,PHN2ZyBmaWxsPSIjNDI4NUY0IiByb2xlPSJpbWciIHZpZXdCb3g9IjAgMCAyNCAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48dGl0bGU+R29vZ2xlIENsb3VkPC90aXRsZT48cGF0aCBkPSJNMTIuMTkgMi4zOGE5LjM0NCA5LjM0NCAwIDAgMC05LjIzNCA2Ljg5M2MuMDUzLS4wMi0uMDU1LjAxMyAwIDAtMy44NzUgMi41NTEtMy45MjIgOC4xMS0uMjQ3IDEwLjk0MWwuMDA2LS4wMDctLjAwNy4wM2E2LjcxNyA2LjcxNyAwIDAgMCA0LjA3NyAxLjM1Nmg1LjE3M2wuMDMuMDNoNS4xOTJjNi42ODcuMDUzIDkuMzc2LTguNjA1IDMuODM1LTEyLjM1YTkuMzY1IDkuMzY1IDAgMCAwLTIuODIxLTQuNTUybC0uMDQzLjA0My4wMDYtLjA1QTkuMzQ0IDkuMzQ0IDAgMCAwIDEyLjE5IDIuMzh6bS0uMzU4IDQuMTQ2YzEuMjQ0LS4wNCAyLjUxOC4zNjggMy40ODYgMS4xNWE1LjE4NiA1LjE4NiAwIDAgMSAxLjg2MiA0LjA3OHYuNTE4YzMuNTMtLjA3IDMuNTMgNS4yNjIgMCA1LjE5M2gtNS4xOTNsLS4wMDguMDA5di0uMDRINi43ODVhMi41OSAyLjU5IDAgMCAxLTEuMDY3LS4yM2guMDAxYTIuNTk3IDIuNTk3IDAgMSAxIDMuNDM3LTMuNDM3bDMuMDEzLTMuMDEyQTYuNzQ3IDYuNzQ3IDAgMCAwIDguMTEgOC4yNGMuMDE4LS4wMS4wNC0uMDI2LjA1NC0uMDIzYTUuMTg2IDUuMTg2IDAgMCAxIDMuNjctMS42OXoiLz48L3N2Zz4=",
      "created": 1706745600000
    }
  }
}
