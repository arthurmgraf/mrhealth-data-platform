{
  "type": "excalidraw",
  "version": 2,
  "source": "claude-code-mrhealth",
  "elements": [
    {"id":"title","type":"text","x":40,"y":20,"width":1200,"height":40,"text":"Camada Silver BigQuery - Schema Limpo e Enriquecido","fontSize":28,"fontFamily":3,"strokeColor":"#4263eb"},
    {"id":"subtitle","type":"text","x":40,"y":65,"width":1200,"height":20,"text":"Dataset: case_ficticio_silver | Transformações: Deduplicação, Cast de Tipos, Normalização, Validação FK | Atualização: CREATE OR REPLACE diário","fontSize":14,"fontFamily":3,"strokeColor":"#868e96"},

    {"id":"orders_box","type":"rectangle","x":40,"y":120,"width":400,"height":420,"strokeColor":"#364fc7","backgroundColor":"#edf2ff","fillStyle":"solid","strokeWidth":2,"roundness":{"type":3}},
    {"id":"orders_header","type":"rectangle","x":40,"y":120,"width":400,"height":40,"strokeColor":"#364fc7","backgroundColor":"#4263eb","fillStyle":"solid","strokeWidth":2},
    {"id":"orders_title","type":"text","x":55,"y":130,"width":370,"height":25,"text":"orders (Limpo e Deduplicado)","fontSize":16,"fontFamily":3,"strokeColor":"#ffffff"},
    {"id":"orders_cols","type":"text","x":55,"y":175,"width":370,"height":355,"text":"PK order_id           STRING         PK (renomeado)\nFK unit_id            INT64          FK → units (validado)\n   order_type         STRING         UPPER() normalizado\n   order_status       STRING         UPPER() normalizado\n   order_value        FLOAT64        ROUND(,2)\n   delivery_fee       FLOAT64        ROUND(,2)\n   order_date         DATE           (renomeado de dt_pedido)\n   total_items        INT64          NOVO CALCULADO\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\nMetadados:\n   _source_file       STRING\n   _ingest_date       DATE\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\nTransformações Aplicadas:\n  ✅ Deduplicação: ROW_NUMBER() OVER\n     (PARTITION BY order_id ORDER BY _ingest DESC)\n  ✅ Renomeação: id_pedido → order_id\n  ✅ Normalização: UPPER(tipo_pedido)\n  ✅ Calculado: total_items de order_items\n  ✅ Validação FK: INNER JOIN valida unit_id","fontSize":10,"fontFamily":3,"strokeColor":"#495057"},

    {"id":"items_box","type":"rectangle","x":470,"y":120,"width":400,"height":420,"strokeColor":"#364fc7","backgroundColor":"#edf2ff","fillStyle":"solid","strokeWidth":2,"roundness":{"type":3}},
    {"id":"items_header","type":"rectangle","x":470,"y":120,"width":400,"height":40,"strokeColor":"#364fc7","backgroundColor":"#4263eb","fillStyle":"solid","strokeWidth":2},
    {"id":"items_title","type":"text","x":485,"y":130,"width":370,"height":25,"text":"order_items (Limpo e Calculado)","fontSize":16,"fontFamily":3,"strokeColor":"#ffffff"},
    {"id":"items_cols","type":"text","x":485,"y":175,"width":370,"height":355,"text":"PK order_item_id      STRING         PK (renomeado)\nFK order_id           STRING         FK → orders (validado)\nFK product_id         INT64          FK → products\n   quantity           INT64          CAST de FLOAT\n   unit_price         FLOAT64        ROUND(,2)\n   total_item_value   FLOAT64        NOVO qty × unit_price\n   observation        STRING         TRIM() + NULLIF('')\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\nMetadados:\n   _source_file       STRING\n   _ingest_date       DATE\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\nTransformações Aplicadas:\n  ✅ Deduplicação: ROW_NUMBER() OVER\n     (PARTITION BY order_item_id ORDER BY _ingest DESC)\n  ✅ Cast de Tipo: CAST(qtd AS INT64)\n  ✅ Calculado: total_item_value = qty × price\n  ✅ Limpeza String: TRIM(), NULLIF vazio\n  ✅ Validação FK: INNER JOIN com orders","fontSize":10,"fontFamily":3,"strokeColor":"#495057"},

    {"id":"products_box","type":"rectangle","x":900,"y":120,"width":320,"height":200,"strokeColor":"#364fc7","backgroundColor":"#edf2ff","fillStyle":"solid","strokeWidth":2,"roundness":{"type":3}},
    {"id":"products_header","type":"rectangle","x":900,"y":120,"width":320,"height":40,"strokeColor":"#364fc7","backgroundColor":"#4263eb","fillStyle":"solid","strokeWidth":2},
    {"id":"products_title","type":"text","x":915,"y":130,"width":290,"height":25,"text":"products (Referência)","fontSize":16,"fontFamily":3,"strokeColor":"#ffffff"},
    {"id":"products_cols","type":"text","x":915,"y":175,"width":290,"height":135,"text":"PK product_id         INT64          PK\n   product_name       STRING         TRIM()\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\nTransformações:\n  ✅ Renomeação: id_produto → product_id\n  ✅ Limpeza String: TRIM(nome_produto)\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\nOrigem: tabela Bronze products","fontSize":10,"fontFamily":3,"strokeColor":"#495057"},

    {"id":"units_box","type":"rectangle","x":900,"y":340,"width":320,"height":260,"strokeColor":"#364fc7","backgroundColor":"#edf2ff","fillStyle":"solid","strokeWidth":2,"roundness":{"type":3}},
    {"id":"units_header","type":"rectangle","x":900,"y":340,"width":320,"height":40,"strokeColor":"#364fc7","backgroundColor":"#4263eb","fillStyle":"solid","strokeWidth":2},
    {"id":"units_title","type":"text","x":915,"y":350,"width":290,"height":25,"text":"units (Desnormalizado)","fontSize":16,"fontFamily":3,"strokeColor":"#ffffff"},
    {"id":"units_cols","type":"text","x":915,"y":395,"width":290,"height":195,"text":"PK unit_id            INT64          PK\n   unit_name          STRING         TRIM()\n   state_id           INT64          NOVO do JOIN\n   state_name         STRING         NOVO do JOIN\n   country_id         INT64          NOVO do JOIN\n   country_name       STRING         NOVO do JOIN\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\nDesnormalização:\n  ✅ JOIN com states\n  ✅ JOIN com countries\n  → Elimina JOINs em runtime\n  → Melhora performance de queries","fontSize":10,"fontFamily":3,"strokeColor":"#495057"},

    {"id":"states_box","type":"rectangle","x":40,"y":560,"width":300,"height":180,"strokeColor":"#364fc7","backgroundColor":"#edf2ff","fillStyle":"solid","strokeWidth":2,"roundness":{"type":3}},
    {"id":"states_header","type":"rectangle","x":40,"y":560,"width":300,"height":40,"strokeColor":"#364fc7","backgroundColor":"#4263eb","fillStyle":"solid","strokeWidth":2},
    {"id":"states_title","type":"text","x":55,"y":570,"width":270,"height":25,"text":"states (Referência)","fontSize":16,"fontFamily":3,"strokeColor":"#ffffff"},
    {"id":"states_cols","type":"text","x":55,"y":615,"width":270,"height":115,"text":"PK state_id           INT64          PK\n   state_name         STRING         TRIM()\nFK country_id         INT64          FK\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\nTransformações:\n  ✅ Renomeação: id_estado → state_id\n  ✅ Limpeza String: TRIM()","fontSize":10,"fontFamily":3,"strokeColor":"#495057"},

    {"id":"countries_box","type":"rectangle","x":370,"y":560,"width":300,"height":180,"strokeColor":"#364fc7","backgroundColor":"#edf2ff","fillStyle":"solid","strokeWidth":2,"roundness":{"type":3}},
    {"id":"countries_header","type":"rectangle","x":370,"y":560,"width":300,"height":40,"strokeColor":"#364fc7","backgroundColor":"#4263eb","fillStyle":"solid","strokeWidth":2},
    {"id":"countries_title","type":"text","x":385,"y":570,"width":270,"height":25,"text":"countries (Referência)","fontSize":16,"fontFamily":3,"strokeColor":"#ffffff"},
    {"id":"countries_cols","type":"text","x":385,"y":615,"width":270,"height":115,"text":"PK country_id         INT64          PK\n   country_name       STRING         TRIM()\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\nTransformações:\n  ✅ Renomeação: id_pais → country_id\n  ✅ Limpeza String: TRIM()","fontSize":10,"fontFamily":3,"strokeColor":"#495057"},

    {"id":"transform_box","type":"rectangle","x":700,"y":620,"width":520,"height":200,"strokeColor":"#1971c2","backgroundColor":"#e7f5ff","fillStyle":"solid","strokeWidth":2},
    {"id":"transform_title","type":"text","x":720,"y":635,"width":300,"height":22,"text":"Resumo de Transformações Silver","fontSize":14,"fontFamily":3,"strokeColor":"#1971c2"},
    {"id":"transform_content","type":"text","x":720,"y":665,"width":480,"height":145,"text":"Tarefas Airflow: run_silver_reference, run_silver_orders\nAgenda: 02:30 BRT diário (após carga Bronze completar)\nOperador: BigQueryInsertJobOperator\n\nTransformações Principais:\n  • Deduplicação: Manter registro mais recente por PK (janela ROW_NUMBER)\n  • Segurança de Tipos: CAST campos numéricos, validar datas\n  • Normalização: UPPER/LOWER, TRIM, NULLIF strings vazias\n  • Campos Calculados: total_items, total_item_value\n  • Integridade Referencial: INNER JOIN valida todos relacionamentos FK\n  • Desnormalização: Achatar hierarquia de geografia na tabela units\n\nSaída: CREATE OR REPLACE TABLE (refresh completo, MERGE planejado para v2)","fontSize":10,"fontFamily":3,"strokeColor":"#495057"}
  ],
  "appState": {"viewBackgroundColor":"#ffffff","gridSize":null},
  "files": {}
}
