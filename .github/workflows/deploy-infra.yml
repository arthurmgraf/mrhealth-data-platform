# F6-04: Deploy Infrastructure
# Manual trigger (workflow_dispatch) for Terraform/Terragrunt apply.
# Uses Workload Identity Federation. Requires manual approval for apply.

name: Deploy Infrastructure

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Target environment"
        required: true
        type: choice
        options:
          - prod
        default: prod
      action:
        description: "Terraform action"
        required: true
        type: choice
        options:
          - plan
          - apply
        default: plan

concurrency:
  group: deploy-infra-${{ github.event.inputs.environment }}
  cancel-in-progress: false

env:
  TF_VERSION: "1.7.0"
  TG_VERSION: "0.55.0"
  GCP_REGION: us-central1

jobs:
  plan:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
      pull-requests: write
    outputs:
      plan_exitcode: ${{ steps.plan.outputs.exitcode }}
    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.GCP_SA_EMAIL }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v3

      - name: Install Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Install Terragrunt
        run: |
          curl -sL "https://github.com/gruntwork-io/terragrunt/releases/download/v${{ env.TG_VERSION }}/terragrunt_linux_amd64" \
            -o /usr/local/bin/terragrunt
          chmod +x /usr/local/bin/terragrunt
          terragrunt --version

      - name: Terragrunt Plan
        id: plan
        working-directory: infra/environments/${{ github.event.inputs.environment }}
        run: |
          terragrunt run-all plan -out=tfplan -detailed-exitcode 2>&1 | tee plan_output.txt
          echo "exitcode=${PIPESTATUS[0]}" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Upload plan artifact
        uses: actions/upload-artifact@v4
        with:
          name: tfplan-${{ github.event.inputs.environment }}
          path: infra/environments/${{ github.event.inputs.environment }}/**/tfplan
          retention-days: 1

      - name: Upload plan output
        uses: actions/upload-artifact@v4
        with:
          name: plan-output-${{ github.event.inputs.environment }}
          path: infra/environments/${{ github.event.inputs.environment }}/plan_output.txt
          retention-days: 7

  apply:
    runs-on: ubuntu-latest
    needs: plan
    if: github.event.inputs.action == 'apply'
    environment: ${{ github.event.inputs.environment }}
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.GCP_SA_EMAIL }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v3

      - name: Install Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Install Terragrunt
        run: |
          curl -sL "https://github.com/gruntwork-io/terragrunt/releases/download/v${{ env.TG_VERSION }}/terragrunt_linux_amd64" \
            -o /usr/local/bin/terragrunt
          chmod +x /usr/local/bin/terragrunt

      - name: Download plan artifact
        uses: actions/download-artifact@v4
        with:
          name: tfplan-${{ github.event.inputs.environment }}
          path: infra/environments/${{ github.event.inputs.environment }}

      - name: Terragrunt Apply
        working-directory: infra/environments/${{ github.event.inputs.environment }}
        run: |
          echo "Applying infrastructure changes to ${{ github.event.inputs.environment }}..."
          terragrunt run-all apply tfplan --terragrunt-non-interactive

      - name: Verify deployment
        run: |
          echo "Infrastructure deployment to ${{ github.event.inputs.environment }} completed."
          gcloud projects describe ${{ secrets.GCP_PROJECT_ID }} --format="value(name)"
